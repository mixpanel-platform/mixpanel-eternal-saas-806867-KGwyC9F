<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <style>
    .mixpanel-platform-select.event_selector_theme {
      max-width: 51px;
    }
    .blank {
      color: #f0f2f6;
    }
    </style>
  </head>
  <body class="mixpanel-platform-body">
    <div class="mixpanel-platform-section" style='width:919px'>
      <table style='width:919px'>
        <tr>
          <td width='150' style='text-align:right'>Event:</td>
          <td width='50' class='blank'>.</td>
          <td><div id="eventSelect" style="float: left;"></div></td>
        </tr>
        <tr><td colspan='3' class='blank'>.</td></tr>
        <tr>
          <td style='text-align:right'>Grouping:</td>
          <td width='50' class='blank'>.</td>
          <td><div id="propSelect" style="float: left;"></div></td>
        </tr>
        <tr><td colspan='3' class='blank'>.</td></tr>
        <tr>
          <td style='text-align:right'>Number of Days:</td>
          <td width='50' class='blank'>.</td>
          <td><div id="num_days" style="float: left;"></div></td>
        </tr>
        <tr><td colspan='3' class='blank'>.</td></tr>
        <tr>
          <td style='text-align:right'>Date Range:</td>
          <td width='50' class='blank'>.</td>
          <td><div id="dateSelect" style="float: left;"></div></td>
        </tr>
      </table>
      <div style="clear: both;"></div>
      <div id="graph"></div>
    </div>
    <div id="table"></div>
    <script id='query'>
      function getBeginningOfBucket(epoch) {
        var today_in_parts = params.to_date.split('-');
        var bucket = new Date(Number(today_in_parts[0]), Number(today_in_parts[1]) - 1, Number(today_in_parts[2]) + 1).valueOf();
        while (epoch < bucket)
          bucket -= params.num_days * 24 * 60 * 60 * 1000;
        return new Date(bucket).toISOString().slice(0, -14);
      }

      function main() {
        if (params.grouping == 'distinct_id') {
          return Events({
            from_date: params.from_date,
            to_date: params.to_date,
            event_selectors: [{event: params.event_name}]
          })
          .groupByUser([item => getBeginningOfBucket(item.time)], (accums, items) => true)
          .groupBy([item => item.key[1]], mixpanel.reducer.count());
        }
        else {
          return Events({
            from_date: params.from_date,
            to_date: params.to_date,
            event_selectors: [{event: params.event_name}]
          })
          .groupBy([
            item => item.properties[params.grouping]? item.properties[params.grouping] : 'No Value',
            item => getBeginningOfBucket(item.time)
            ], (accums, items) => true)
          .groupBy([item => item.key[1]], mixpanel.reducer.count());
        }
      }
    </script>
    <script>
      var eventSelect = $('#eventSelect').MPEventSelect();
      var propSelect  = $('#propSelect').MPPropertySelect();
      propSelect.MPPropertySelect('setEvent');
      var dateSelect  = $('#dateSelect').MPDatepicker();
      var items = function() {return item_list = _.map(arguments, function(item) {return {label: String(item), value: item};})};
      var bucket_size = $('#num_days').MPSelect({items: items(1,2,7,14,30)});
      bucket_size.val(7);
      var eventGraph  = $('#graph').MPChart({chartType: 'line'});
      var eventTable  = $('#table').MPTable({
        showPercentages: true,
        firstColHeader: 'Event'
      });

      var runQuery = function() {
        var script = document.getElementById('query').innerHTML;
        var params = {
          event_name: eventSelect.MPEventSelect('value'),
          grouping: propSelect.MPPropertySelect('value')? propSelect.MPPropertySelect('value') : 'distinct_id',
          num_days: bucket_size.MPSelect('value'),
          from_date: dateSelect.MPDatepicker('value').from.toISOString().slice(0, -14),
          to_date: dateSelect.MPDatepicker('value').to.toISOString().slice(0, -14),
        };

        if (params.event_name) {
          MP.api.jql(script, params).done(function(results) {
            var res = {};
            var group = params.grouping == 'distinct_id'? 'Users' : params.grouping;
            res[group] = {};
            _.each(results, function(item) {
              res[group][item.key[0]] = item.value;
            });
            eventGraph.MPChart('setData', res);
            eventTable.MPTable('setData', res);
          });
        }
      };
      eventSelect.on('change', function(e, eventName) {
        propSelect.MPPropertySelect('setEvent', eventName);
        runQuery();
      });
      propSelect.on('change', runQuery);
      dateSelect.on('change', runQuery);
      bucket_size.on('change', function(e, selection) {runQuery();});
    </script>
  </body>
</html>
